<% layout("/layouts/boilerplate") %>
<div class="listings-container">
  <h1>My Listings</h1>

  <div class="toggle-buttons">
    <% if (activeListing && activeListing.length > 0) { %>
    <button
      class="toggle-btn <%= activeListing.length > 0 ? 'active' : '' %>"
      data-type="active"
      onclick="showTable('active')"
    >
      Active Listings
    </button>
    <% } %> <% if (inactiveListing && inactiveListing.length > 0) { %>
    <button
      class="toggle-btn <%= (!activeListing || activeListing.length === 0) ? 'active' : '' %>"
      data-type="inactive"
      onclick="showTable('inactive')"
    >
      Inactive Listings
    </button>
    <% } %>
  </div>

  <div
    id="active-table"
    class="table-container <%= (!activeListing || activeListing.length === 0) ? 'hidden' : '' %>"
  >
    <table>
      <thead>
        <tr>
          <th>Photo</th>
          <th>Title</th>
          <th>Place Type</th>
          <th>City</th>
          <th>Rating</th>
          <th>Price / Night</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% for(let listing of activeListing) { %>
        <tr data-listing-id="<%= listing._id %>" class="listing-row">
          <td>
            <img
              src="<%= listing.thumbnail.url %>"
              alt="<%= listing.thumbnail.filename %>"
              class="property-photo"
            />
          </td>
          <td class="property-title"><%= listing.title %></td>
          <td class="place-type">
            <%= listing.typeOfPlace %> · <%= listing.propertyType %>
          </td>
          <td class="city"><%= listing.address.city %></td>
          <td>
            <div class="rating">
              <span class="star-icon">★</span>
              <span class="rating-value"><%= listing.avgRating %></span>
            </div>
          </td>
          <td class="price">
            &#8377; <%= listing.price.toLocaleString("en-IN") %>
          </td>
          <td>
            <div class="actions">
              <a
                href="/listings/<%= listing._id %>/bookings"
                class="btn btn-primary"
                >Bookings</a
              >
              <div class="dropdown">
                <button class="btn btn-icon" onclick="toggleDropdown(this)">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="19" cy="12" r="1"></circle>
                    <circle cx="5" cy="12" r="1"></circle>
                  </svg>
                </button>
                <div class="dropdown-menu">
                  <a
                    href="/listings/<%= listing._id %>/edit"
                    class="dropdown-item update-item"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                      ></path>
                      <path
                        d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                      ></path>
                    </svg>
                    Update
                  </a>
                  <button
                    class="dropdown-item inactive-item"
                    onclick="openConfirmationModal('<%= listing._id %>', 'inactive')"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"
                      ></path>
                      <line x1="1" y1="1" x2="23" y2="23"></line>
                    </svg>
                    Make Inactive
                  </button>
                  <button
                    class="dropdown-item delete-item"
                    onclick="openDeleteConfirmationModal('<%= listing._id %>')"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path
                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                      ></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </div>

  <div
    id="inactive-table"
    class="table-container <%= (activeListing && activeListing.length > 0) ? 'hidden' : '' %>"
  >
    <table>
      <thead>
        <tr>
          <th>Photo</th>
          <th>Title</th>
          <th>Place Type</th>
          <th>City</th>
          <th>Rating</th>
          <th>Price / Night</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <% for(let listing of inactiveListing) { %>
        <tr data-listing-id="<%= listing._id %>" class="listing-row">
          <td>
            <img
              src="<%= listing.thumbnail.url %>"
              alt="<%= listing.thumbnail.filename %>"
              class="property-photo"
            />
          </td>
          <td class="property-title"><%= listing.title %></td>
          <td class="place-type">
            <%= listing.typeOfPlace %> · <%= listing.propertyType %>
          </td>
          <td class="city"><%= listing.address.city %></td>
          <td>
            <div class="rating">
              <span class="star-icon">★</span>
              <span class="rating-value"><%= listing.avgRating %></span>
            </div>
          </td>
          <td class="price">
            &#8377; <%= listing.price.toLocaleString("en-IN") %>
          </td>
          <td>
            <div class="actions">
              <button class="btn btn-primary">Bookings</button>
              <div class="dropdown">
                <button class="btn btn-icon" onclick="toggleDropdown(this)">
                  <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="currentColor"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                  >
                    <circle cx="12" cy="12" r="1"></circle>
                    <circle cx="19" cy="12" r="1"></circle>
                    <circle cx="5" cy="12" r="1"></circle>
                  </svg>
                </button>
                <div class="dropdown-menu">
                  <a
                    href="/listings/<%= listing._id %>/edit"
                    class="dropdown-item update-item"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"
                      ></path>
                      <path
                        d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"
                      ></path>
                    </svg>
                    Update
                  </a>
                  <button
                    class="dropdown-item status-item"
                    onclick="openConfirmationModal('<%= listing._id %>', 'active')"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <path
                        d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"
                      ></path>
                      <circle cx="12" cy="12" r="3"></circle>
                    </svg>
                    Make Active
                  </button>
                  <button
                    class="dropdown-item delete-item"
                    onclick="openDeleteConfirmationModal('<%= listing._id %>', '<%= listing.title.replace(/'/g, `\\'`) %>', '<%= listing.thumbnail.url %>')"
                  >
                    <svg
                      xmlns="http://www.w3.org/2000/svg"
                      viewBox="0 0 24 24"
                      fill="none"
                      stroke="currentColor"
                      stroke-linecap="round"
                      stroke-linejoin="round"
                    >
                      <polyline points="3 6 5 6 21 6"></polyline>
                      <path
                        d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"
                      ></path>
                      <line x1="10" y1="11" x2="10" y2="17"></line>
                      <line x1="14" y1="11" x2="14" y2="17"></line>
                    </svg>
                    Delete
                  </button>
                </div>
              </div>
            </div>
          </td>
        </tr>
        <% } %>
      </tbody>
    </table>
  </div>
</div>

<div id="confirmation-modal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-listing-info">
      <img id="modal-listing-img" src="" alt="Listing Thumbnail" />
      <h3 id="modal-listing-title">Listing Title Will Go Here</h3>
    </div>

    <h2 id="modal-title">Confirm Action</h2>
    <p id="modal-text">Are you sure you want to perform this action?</p>

    <div class="modal-actions">
      <button id="modal-cancel-btn" class="btn btn-secondary">Cancel</button>
      <form id="modal-confirm-form" method="POST" action="">
        <button id="modal-confirm-btn" type="submit" class="btn">
          Confirm
        </button>
      </form>
    </div>
  </div>
</div>

<script>
  const allListingsFromServer = <%- JSON.stringify([...activeListing, ...inactiveListing]) %>;

  const listingsData = {};
  allListingsFromServer.forEach(listing => {
    listingsData[listing._id] = listing;
  });
</script>
